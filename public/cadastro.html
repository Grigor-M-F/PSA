<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../public/assets/img/imgMedicina.png" type="image/png">
    <link rel="stylesheet" href="../public/css/global.css">
    <link rel="stylesheet" href="">
    <title>Cadastro PSA</title>
</head>

<body onload="listar()">
    <div class="container">
        <div class="form-img">
        </div>
    </div>
    <div class="form">
        <form>
            <div class="form-header">
                <div class="title">
                    <h1>Preencha todos os campos para acessar nossa Dashboard</h1>
                </div>
            </div>
            <div class="input-group">
                <div class="input-box">
                    <div class="form-control">
                        <label>Nome Completo</label>
                        <input type="text" oninput="validar()" id="iptNome" placeholder="Insira seu nome">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>Email</label>
                        <input type="text" oninput="valiar()" id="iptEmail" placeholder="Insira seu Email">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>Data de Nascimento</label>
                        <input type="date" oninput="validar()" id="iptData"
                            placeholder="Selecione sua data de Nascimento">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>CPF</label>
                        <input type="number" oninput="validar()" id="iptCpf" placeholder="Insira seu CPF">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>Telefone</label>
                        <input type="number" oninput="validar()" id="iptTelefone" placeholder="Insira seu Telefone">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>Senha</label>
                        <input type="password" oninput="validar()" id="iptSenha" placeholder="Insira sua Senha">
                        <span id="erro"></span>
                    </div>
                    <div class="form-control">
                        <label>Confirmar Senha</label>
                        <input type="password" oninput="validar()" id="iptSenhaConfirm"
                            placeholder="Repita sua senha para confirmação">
                        <span id="erro"></span>
                    </div>
                    <div class="button">
                        <a href="">
                            <button onclick="cadastrar()">Cadastrar</button>
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

</body>

</html>

<script>
    var char = ['@', '#', '$', '%', '&', '*', '?', 'ª', 'º', '§']
    var password = false;

    function validar() {
        var nome = iptNome.toLowerCase.value;
        var email = iptEmail.value;
        var dtNasc = iptData.value;
        var cpf = Number(iptCpf.value);
        var telefone = Number(iptTelefone.value);
        var senha = iptSenha.value;
        var confirmSenha = iptSenhaConfirm.value;

        var erro = document.getElementById("erro");

        for (var i = 0; i < char.length; i++) {
            if (senha.includes(char[i])) {
                password = true;
            }
        }

        if (nome.includes(" ") == false) {
            erro.innerHTML = `<span style="color: red;">Seu nome não é composto</span>`;
            return;
        } else if (email.includes("@") == false || email.includes(".") == false) {
            erro.innerHTML = `<span style="color: red;">Não possuí @ ou dominio</span>`;
            return;
        } else if (dtNasc) {

        } else if (cpf.length != 11 || cpf == NaN) {
            erro.innerHTML = `<span style="color: red;">Só pode inserir onze números e aceita apenas números</span>`;
            return;
        } else if (telefone.length != 11 || telefone == NaN) {
            erro.innerHTML = `<span style="color: red;">Telefone tem que ter 11 digitos e só pode ser número</span>`;
            return;
        } else if (senha.length < 8 || password) {
            erro.innerHTML = `<span style="color: red;">Senha menor que 8 digitos e não contém caracter especial</span>`;
            return;
        } else if (senha != confirmSenha) {
            erro.innerHTML = `<span style="color: red;">Confirmação de senha diferente da senha do campo anterior.</span>`;
            return;
        }

    }

    function cadastrar() {
        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                dtNascServer: dtNasc,
                cpfServer: cpf,
                telefoneServer: telefone,
                senhaServer: senha
            }),
        })

            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    cardErro.style.display = "block";

                    mensagem_erro.innerHTML =
                        "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

                    setTimeout(() => {
                        window.location = "login.html";
                    }, "2000");

                    limparFormulario();
                    finalizarAguardar();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });

        return false;
    }

    // Listando empresas cadastradas 
    function listar() {
        fetch("/empresas/listar", {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((empresas) => {
                    empresas.forEach((empresa) => {
                        listaEmpresasCadastradas.push(empresa);

                        console.log("listaEmpresasCadastradas")
                        console.log(listaEmpresasCadastradas[0].codigo_ativacao)
                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

</script>